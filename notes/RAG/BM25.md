## BM25 (Best Matching 25)

---

### 정의

1994년 Stephen Robertson 등이 제안한 **확률적 정보 검색 알고리즘**입니다. 쿼리와 문서 간의 관련성 점수를 계산하여 문서 순위를 매깁니다. TF-IDF의 개선 버전으로, 현재까지도 검색 엔진의 표준 알고리즘으로 사용됩니다.

---

### 핵심 구성 요소

#### 1. TF (Term Frequency) - 단어 빈도

문서 내 검색어 등장 횟수. 많이 나올수록 관련성 높음.

#### 2. IDF (Inverse Document Frequency) - 역문서 빈도

전체 문서 중 해당 단어가 등장하는 문서 비율의 역수. 희귀한 단어일수록 중요.

#### 3. 문서 길이 정규화

긴 문서는 단어가 많이 등장할 확률이 높으므로 보정.

---

### 수식

```
score(D, Q) = Σ IDF(qi) × (f(qi, D) × (k1 + 1)) / (f(qi, D) + k1 × (1 - b + b × |D|/avgdl))
```

| 기호       | 의미                                |
| ---------- | ----------------------------------- | --- | ------------- |
| `f(qi, D)` | 문서 D에서 단어 qi의 등장 횟수      |
| `          | D                                   | `   | 문서 D의 길이 |
| `avgdl`    | 전체 문서 평균 길이                 |
| `k1`       | TF 포화 파라미터 (보통 1.2~2.0)     |
| `b`        | 문서 길이 보정 파라미터 (보통 0.75) |

---

### 파라미터 튜닝

| 파라미터 | 기본값  | 역할                | 조정                             |
| -------- | ------- | ------------------- | -------------------------------- |
| **k1**   | 1.2~2.0 | TF 포화 속도        | 높으면 빈도 영향 ↑               |
| **b**    | 0.75    | 문서 길이 보정 강도 | 0이면 길이 무시, 1이면 완전 보정 |

```
b = 0.0 → 문서 길이 보정 안 함 (긴 문서 유리)
b = 1.0 → 문서 길이 완전 보정 (짧은 문서 유리)
b = 0.75 → 균형 (기본값)
```

---

### 장단점

| 장점                                 | 단점                 |
| ------------------------------------ | -------------------- |
| 빠른 계산 속도                       | 의미/문맥 이해 못 함 |
| 해석 가능 (왜 이 결과인지 설명 가능) | 동의어 처리 불가     |
| 튜닝 파라미터 적음                   | 오타에 취약          |
| 긴 쿼리에도 안정적                   | 단어 순서 무시       |
| 검증된 알고리즘 (30년+)              | 다국어 처리 어려움   |

---

### TF-IDF와 비교

| 항목      | TF-IDF     | BM25              |
| --------- | ---------- | ----------------- |
| TF 처리   | 선형 증가  | 포화 (saturation) |
| 문서 길이 | 고려 안 함 | 정규화            |
| 파라미터  | 없음       | k1, b             |
| 성능      | 기본       | 더 우수           |

```
TF-IDF: 단어 10번 = 단어 1번의 10배 점수
BM25:   단어 10번 ≈ 단어 5번과 비슷 (포화)
```

---

### 변형 버전들

| 버전      | 특징                          |
| --------- | ----------------------------- |
| **BM25+** | 긴 문서 페널티 완화           |
| **BM25L** | 긴 문서에서 TF 보정 개선      |
| **BM25F** | 필드별 가중치 (제목, 본문 등) |
| **BM25T** | 동적 k1 조정                  |

---

### 활용 분야

| 분야               | 사용 예                                   |
| ------------------ | ----------------------------------------- |
| **검색 엔진**      | Elasticsearch, Solr, Lucene 기본 알고리즘 |
| **추천 시스템**    | 콘텐츠 기반 필터링                        |
| **질의응답**       | 관련 문서/문단 검색                       |
| **RAG**            | Retrieval 단계에서 후보 문서 추출         |
| **표절 탐지**      | 유사 문서 탐색                            |
| **법률/의료 검색** | 정확한 키워드 매칭 필요한 도메인          |

---

### 주요 구현체

| 도구              | 설명                          |
| ----------------- | ----------------------------- |
| **Elasticsearch** | 기본 유사도 알고리즘으로 채택 |
| **Lucene**        | Java 검색 라이브러리          |
| **Whoosh**        | Python 검색 라이브러리        |
| **rank_bm25**     | Python 경량 라이브러리        |
| **Gensim**        | Python NLP 라이브러리         |

---

### Python 구현 예시

```python
from rank_bm25 import BM25Okapi

# 문서 준비 (토큰화 필요)
corpus = [
    ["삼성전자", "반도체", "실적", "발표"],
    ["LG전자", "가전", "매출", "증가"],
    ["SK하이닉스", "반도체", "생산", "확대"],
]

# BM25 인덱스 생성
bm25 = BM25Okapi(corpus)

# 검색
query = ["반도체", "실적"]
scores = bm25.get_scores(query)
# [0.82, 0.0, 0.41]  → 첫 번째 문서가 가장 관련 높음

# 상위 N개 문서
top_docs = bm25.get_top_n(query, corpus, n=2)
```

---

### 현대적 활용: Hybrid Search

BM25(Sparse)와 Neural Embedding(Dense)을 결합하여 상호 보완.

```
BM25:  정확한 키워드 매칭 (고유명사, 코드명 등)
Dense: 의미적 유사성 (동의어, 문맥 이해)
Hybrid: 둘의 결과를 병합 (RRF, 가중합 등)
```

| 검색 유형        | BM25 | Dense | Hybrid |
| ---------------- | ---- | ----- | ------ |
| 키워드 정확 매칭 | ◎    | △     | ◎      |
| 의미 유사 검색   | ✗    | ◎     | ◎      |
| 동의어/유사어    | ✗    | ◎     | ○      |
| 오타 허용        | ✗    | ○     | ○      |

---

### 요약

BM25는 **확률 기반의 전통적인 텍스트 검색 알고리즘**으로, TF-IDF를 개선하여 단어 빈도 포화와 문서 길이 정규화를 적용한 것입니다. 30년 넘게 검색 엔진의 표준으로 사용되어 왔으며, 최근에는 딥러닝 기반 임베딩과 결합한 Hybrid Search 형태로 활용됩니다.
